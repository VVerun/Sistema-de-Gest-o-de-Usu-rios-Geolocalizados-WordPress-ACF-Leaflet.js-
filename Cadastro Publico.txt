<style>
  body{ background:#1f1f23; }

  .pwrap{
    max-width: 920px;
    margin: 0 auto;
    padding: 18px 20px 20px;
    border-radius: 16px;
    background: #2b2b31;
    border: 1px solid rgba(255,255,255,0.06);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    overflow:hidden;
  }

  .phead{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom: 16px;
    flex-wrap:wrap;
  }

  .ptitle{
    font-size: 22px;
    font-weight: 800;
    margin: 0;
    color: #fff;
  }

  .psub{
    margin: 0;
    color:#cfcfcf;
    font-size: 13px;
  }

  .ptag{
    display:inline-block;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 800;
    color:#000;
    background:#00ff01;
    white-space:nowrap;
    height: fit-content;
  }

  .pgrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-top: 14px;
  }

  .pfield label{
    display:block;
    font-size: 12px;
    color:#fff;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .pfield input,
  .pfield select{
    width: 100%;
    padding: 12px;
    border: 1px solid #4b4b55;
    border-radius: 12px;
    outline: none;
    background:#3a3a42;
    color:#fff;
    transition: 0.2s;
  }

  .pfield input:focus,
  .pfield select:focus{
    border-color:#00ff01;
    box-shadow: 0 0 0 3px rgba(0,255,1,0.2);
  }

  .phint{
    margin-top: 10px;
    font-size: 12px;
    color:#cfcfcf;
    line-height:1.35;
  }

  .pfile{
    border:1px dashed rgba(255,255,255,0.22);
    border-radius:12px;
    padding:12px;
    background: rgba(255,255,255,0.05);
  }
  .pfileRow{
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
  }
  .ppreview{
    width:54px;
    height:54px;
    border-radius:12px;
    object-fit:cover;
    display:none;
    border:1px solid rgba(255,255,255,0.18);
  }

  .pmapwrap{
    margin-top: 18px;
    border-radius: 16px;
    overflow:hidden;
    border: 2px solid #444;
  }

  #map-cadastro{
    height: 420px;
    width: 100%;
  }

  .pactions{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-top: 18px;
    flex-wrap:wrap;
  }

  .pbtn{
    padding: 12px 18px;
    border: none;
    border-radius: 14px;
    background: #00ff01;
    color: #000;
    font-weight: 900;
    cursor:pointer;
    transition: 0.2s;
  }

  .pbtn:hover{
    background: #00d800;
    transform: translateY(-2px);
  }

  .pbtn:disabled{
    opacity:.6;
    cursor:not-allowed;
  }

  .pmsg{
    margin-left:auto;
    font-size: 13px;
    font-weight: 700;
    color:#fff;
  }

  .perr{ color:#ff4d4d; font-weight:800; }

  .pback{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.14);
    background:#3a3a42;
    color:#fff;
    font-weight:950;
    text-decoration:none;
    font-size:13px;
    transition:0.2s;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .pback:hover{
    color:#000000;
    border-color:#00ff01;
    box-shadow:0 0 0 3px rgba(0,255,1,0.12);
  }

  .pheadLeft{
    display:flex;
    flex-direction:column;
    gap:8px;
    min-width:0;
  }
  .pheadTopRow{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .pbackBottom{ display:none; }

  html, body{ overflow-x:hidden; }

  @media (max-width: 760px){
    .pwrap{ padding:16px 14px 18px; }
    .pgrid{ grid-template-columns: 1fr; }
    #map-cadastro{ height: 360px; }

    .phead{ flex-direction:column; align-items:stretch; }
    .ptag{ width:fit-content; }

    .pactions{ flex-direction:column; align-items:stretch; }
    .pbtn{ width:100%; justify-content:center; }
    .pmsg{ margin-left:0; width:100%; text-align:center; }

    .pbackBottom{
      display:inline-flex;
      width:100%;
      justify-content:center;
      margin-top: 6px;
    }
  }
</style>

<div class="pwrap">
  <div class="phead">
    <div class="pheadLeft">
      <div class="pheadTopRow">
        <a href="/painel" class="pback">← Voltar ao Painel</a>
      </div>

      <div>
        <p class="ptitle">Cadastrar pessoa</p>
        <p class="psub">Preencha os dados e marque no mapa.</p>
      </div>
    </div>

    <span id="coord-status" class="ptag">Localização: não marcada</span>
  </div>

  <form id="pessoas-form">
    <div class="pgrid">
      <div class="pfield">
        <label>Nome</label>
        <input name="nome" required placeholder="Ex: João da Silva">
      </div>

      <div class="pfield">
        <label>Telefone</label>
        <input name="telefone" required placeholder="(21) 99999-9999">
      </div>

      <div class="pfield">
        <label>Setor</label>
        <select name="setor" required>
          <option value="">Selecione</option>
          <option value="financeiro">Financeiro</option>
          <option value="comercial">Comercial</option>
          <option value="operacional">Operacional</option>
          <option value="rh">RH</option>
          <option value="administrativo">Administrativo</option>
        </select>
      </div>

      <div class="pfield">
        <label>Status</label>
        <select name="status" required>
          <option value="ativo" selected>Ativo</option>
          <option value="inativo">Inativo</option>
        </select>
      </div>

      <!-- ✅ Rank fixo -->
      <div class="pfield" style="grid-column: 1 / -1;">
        <label>Rank</label>
        <input id="rankFixed" disabled value="Em análise" />
        <div class="phint">No cadastro público o rank fica fixo como “Em análise”.</div>
      </div>

      <div class="pfield pfile" style="grid-column: 1 / -1;">
        <label>Foto </label>
        <div class="pfileRow">
          <input id="foto" name="foto" type="file" accept="image/*">
          <img id="fotoPreview" class="ppreview" alt="Prévia">
          <span class="phint" style="margin:0;">Se quiser, use uma foto quadrada.</span>
        </div>
      </div>

      <!-- ✅ Endereço digitado -->
      <div class="pfield" style="grid-column: 1 / -1;">
        <label>Endereço:</label>
        <input id="addr" name="endereco_texto" placeholder="Digite um endereço e pressione Enter">
        <div class="phint">Pressione Enter para buscar e marcar o ponto automaticamente (ou clique no mapa).</div>
      </div>
    </div>

    <div class="pmapwrap">
      <div id="map-cadastro"></div>
    </div>

    <input type="hidden" id="lat" name="latitude" required>
    <input type="hidden" id="lng" name="longitude" required>

    <div class="pactions">
      <button class="pbtn" id="btnSalvar" type="submit">Cadastrar</button>
      <span class="pmsg" id="msg"></span>
      <a href="/painel" class="pback pbackBottom">← Voltar ao Painel</a>
    </div>
  </form>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
window.addEventListener('load', function () {

  var cfg = document.getElementById('restcfg');
  var REST = cfg ? cfg.dataset.rest : null;
  var NONCE = cfg ? cfg.dataset.nonce : null;

  var msg = document.getElementById('msg');
  var coordStatus = document.getElementById('coord-status');
  var btnSalvar = document.getElementById('btnSalvar');

  var TAX_REST_BASE = 'classificacao';

  if (!REST || !NONCE) {
    msg.innerHTML = '<span class="perr">Faltou o shortcode [rest_cfg] na página.</span>';
    btnSalvar.disabled = true;
    return;
  }

  // ===== pega o ID do termo "em-analise" =====
  var emAnaliseTermId = null;

  async function loadEmAnaliseId(){
    try{
      var resp = await fetch(REST + 'wp/v2/' + TAX_REST_BASE + '?per_page=100', {
        headers: { 'X-WP-Nonce': NONCE }
      });
      if(!resp.ok){
        console.log('Erro carregando ranks:', await resp.text());
        return null;
      }
      var terms = await resp.json();
      var t = terms.find(function(x){ return (x.slug || '').toLowerCase() === 'em-analise'; });
      if (!t) t = terms.find(function(x){ return (x.slug || '').toLowerCase() === 'em_analise'; });
      return t ? parseInt(t.id, 10) : null;
    }catch(e){
      console.log(e);
      return null;
    }
  }

  // ===== Mapa =====
  var DEFAULT_VIEW = { lat: -14.2350, lng: -51.9253, zoom: 4 };
  var map = L.map('map-cadastro').setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.zoom);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  var marker = null;

  function setLatLng(lat, lng) {
    document.getElementById('lat').value = lat.toFixed(6);
    document.getElementById('lng').value = lng.toFixed(6);
    coordStatus.textContent = 'Localização: marcada';

    if (marker) marker.setLatLng([lat, lng]);
    else marker = L.marker([lat, lng]).addTo(map);

    map.setView([lat, lng], 14);
  }

  map.on('click', function (e) {
    setLatLng(e.latlng.lat, e.latlng.lng);
  });

  // Buscar endereço e marcar no mapa
  document.getElementById('addr').addEventListener('keydown', function (ev) {
    if (ev.key !== 'Enter') return;
    ev.preventDefault();

    var q = ev.target.value.trim();
    if (!q) return;

    msg.textContent = 'Buscando endereço...';

    fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(q))
      .then(function (r) { return r.json(); })
      .then(function (res) {
        if (!res || !res.length) {
          msg.innerHTML = '<span class="perr">Endereço não encontrado.</span>';
          return;
        }
        msg.textContent = '';
        setLatLng(parseFloat(res[0].lat), parseFloat(res[0].lon));
      })
      .catch(function () {
        msg.innerHTML = '<span class="perr">Falha na busca do endereço.</span>';
      });
  });

  // Preview foto
  document.getElementById('foto').addEventListener('change', function () {
    var file = this.files && this.files[0];
    var prev = document.getElementById('fotoPreview');
    if (!file) { prev.style.display = 'none'; prev.src = ''; return; }
    prev.src = URL.createObjectURL(file);
    prev.style.display = 'block';
  });

  // ✅ igual ao admin: upload no /media e retorna ID
  async function uploadImage(file){
    var resp = await fetch(REST + 'wp/v2/media', {
      method: 'POST',
      headers: {
        'X-WP-Nonce': NONCE,
        'Content-Disposition': 'attachment; filename="' + encodeURIComponent(file.name) + '"'
      },
      body: file
    });

    if (!resp.ok) {
      console.log('Erro upload:', await resp.text());
      throw new Error('Falha no upload da imagem');
    }

    var media = await resp.json();
    return media.id;
  }

  document.getElementById('pessoas-form').addEventListener('submit', async function (ev) {
    ev.preventDefault();
    msg.textContent = '';

    var f = ev.target;
    var lat = document.getElementById('lat').value;
    var lng = document.getElementById('lng').value;

    if (!lat || !lng) {
      msg.innerHTML = '<span class="perr">Clique no mapa para marcar a localização.</span>';
      return;
    }

    // garante o termo "em-analise"
    if (!emAnaliseTermId) {
      msg.textContent = 'Carregando rank padrão...';
      emAnaliseTermId = await loadEmAnaliseId();
    }
    if (!emAnaliseTermId) {
      msg.innerHTML = '<span class="perr">Não achei o rank “Em análise”. Confere o slug em-analise na taxonomia.</span>';
      return;
    }

    btnSalvar.disabled = true;
    msg.textContent = 'Salvando...';

    try {
      // ✅ foto primeiro (igual admin)
      var fotoId = null;
      var fotoFile = document.getElementById('foto').files && document.getElementById('foto').files[0];
      if (fotoFile) {
        msg.textContent = 'Enviando foto...';
        fotoId = await uploadImage(fotoFile);
        msg.textContent = 'Salvando cadastro...';
      }

      // ✅ endereço texto
      var enderecoTexto = (f.endereco_texto && f.endereco_texto.value) ? f.endereco_texto.value.trim() : '';

      var payload = {
        title: f.nome.value,
        status: 'publish',

        // ✅ público sempre em análise
        classificacao: [emAnaliseTermId],

        // ✅ tudo no ACF, igual admin
        acf: {
          telefone: f.telefone.value,
          setor: f.setor.value,
          status: f.status.value,
          latitude: lat,
          longitude: lng,

          // campos novos
          endereco_texto: enderecoTexto,
          foto: fotoId,

          // mantém compatibilidade se você usa rank no ACF também
          rank: emAnaliseTermId
        }
      };

      var resp = await fetch(REST + 'wp/v2/pessoas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-WP-Nonce': NONCE
        },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        console.log('Erro REST:', await resp.text());
        msg.innerHTML = '<span class="perr">Erro ao salvar. Veja o console (F12).</span>';
        btnSalvar.disabled = false;
        return;
      }

      msg.textContent = 'Cadastrado com sucesso! (Em análise)';
      f.reset();

      document.getElementById('lat').value = '';
      document.getElementById('lng').value = '';
      coordStatus.textContent = 'Localização: não marcada';

      var prev = document.getElementById('fotoPreview');
      prev.style.display = 'none';
      prev.src = '';

      if (marker) { map.removeLayer(marker); marker = null; }
      map.setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.zoom);

      btnSalvar.disabled = false;

    } catch (e) {
      console.log(e);
      msg.innerHTML = '<span class="perr">Erro inesperado ao salvar.</span>';
      btnSalvar.disabled = false;
    }
  });

});
</script>
